/*! angular-yandex-maps 15-03-2019 */
"use strict";function CollectionCtrl(a){this.addGeoObjects=function(b){a.collection.add(b)},this.removeGeoObjects=function(b){a.collection.remove(b)}}function YaMapCtrl(a,b){var c=this;b(function(){c.addGeoObjects=function(b){a.map.geoObjects.add(b)},c.removeGeoObjects=function(b){a.map.geoObjects.remove(b)},c.addControl=function(b,c){a.map.controls.add(b,c)},c.getMap=function(){return a.map},c.addImageLayer=function(b,c){var d=new ymaps.Layer(b,c);a.map.layers.add(d)},c.addHotspotLayer=function(b,c,d){var e=new ymaps.hotspot.ObjectSource(b,c),f=new ymaps.hotspot.Layer(e,d);a.map.layers.add(f)}})}function defineArrow(){ymaps.modules.define("geoObject.Arrow",["Polyline","overlay.Arrow","util.extend"],function(a,b,c,d){var e=function(a,e,f){return new b(a,e,d({},f,{lineStringOverlay:c}))};a(e)}),ymaps.modules.define("overlay.Arrow",["overlay.Polygon","util.extend","event.Manager","option.Manager","Event","geometry.pixel.Polygon"],function(a,b,c,d,e,f,g){function h(a,b,c){var d=a[0],e=a[1],f=b*Math.sin(c),g=e[1]-b*Math.cos(c);return[[d[0]-f,g],[d[0]+f,g]]}function i(a,b){for(var c,d,e=[],f=0,g=a.length;g>f;f++)c=a[f][0],d=a[f][1],e.push([c*Math.cos(b)-d*Math.sin(b),c*Math.sin(b)+d*Math.cos(b)]);return e}function j(a,b){return Math.PI/2-Math.atan2(b[1]-a[1],b[0]-a[0])}function k(a){for(var b=a.slice(),c=a.length-2;c>-1;c--)b.push(a[c]);return b}function l(a,b,c){for(var d=0,e=1,f=a.length;f>e;e++)if(d+=m(a[e][0]-a[e-1][0],a[e][1]-a[e-1][1]),d/3>c)return c;var g=d/3;return b>g?0:g}function m(a,b){return Math.sqrt(a*a+b*b)}var n=["click","contextmenu","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseup","multitouchend","multitouchmove","multitouchstart","wheel"],o=function(a,b,c){this.events=new d,this.options=new e(c),this._map=null,this._data=b,this._geometry=a,this._overlay=null};o.prototype=c(o.prototype,{getData:function(){return this._data},setData:function(a){if(this._data!=a){var b=this._data;this._data=a,this.events.fire("datachange",{oldData:b,newData:a})}},getMap:function(){return this._map},setMap:function(a){if(this._map!=a){var b=this._map;a||this._onRemoveFromMap(),this._map=a,a&&this._onAddToMap(),this.events.fire("mapchange",{oldMap:b,newMap:a})}},setGeometry:function(a){if(this._geometry!=a){var b=a;this._geometry=a,this.getMap()&&a&&this._rebuild(),this.events.fire("geometrychange",{oldGeometry:b,newGeometry:a})}},getGeometry:function(){return this._geometry},getShape:function(){return null},isEmpty:function(){return!1},_rebuild:function(){this._onRemoveFromMap(),this._onAddToMap()},_onAddToMap:function(){this._overlay=new b(new g(this._createArrowContours())),this._startOverlayListening(),this._overlay.options.setParent(this.options),this._overlay.setMap(this.getMap())},_onRemoveFromMap:function(){this._overlay.setMap(null),this._overlay.options.setParent(null),this._stopOverlayListening()},_startOverlayListening:function(){this._overlay.events.add(n,this._onDomEvent,this)},_stopOverlayListening:function(){this._overlay.events.remove(n,this._onDomEvent,this)},_onDomEvent:function(a){this.events.fire(a.get("type"),new f({target:this},a))},_createArrowContours:function(){var a=[],b=this.getGeometry().getCoordinates(),c=l(b,this.options.get("arrowMinLength",3),this.options.get("arrowMaxLength",20));if(a.push(k(b)),c>0){var d=[b[b.length-2],b[b.length-1]],e=j(d[0],d[1]),f=i(d,e),g=this.options.get("arrowAngle",20)/180*Math.PI,m=h(f,c,g),n=i([m[0],f[1]],-e),o=i([m[1],f[1]],-e);a.push(k(n)),a.push(k(o))}return a}}),a(o)})}window.onYaMapLoad=function(){console.log("onYaMapLoad"),defineArrow(),ymaps.modules.require(["geoObject.Arrow"],function(a){ymaps.Arrow=a})},angular.module("yaMap",[]).constant("GEOMETRY_TYPES",{POINT:"Point",LINESTRING:"LineString",RECTANGLE:"Rectangle",POLYGON:"Polygon",CIRCLE:"Circle"}).factory("mapApiLoad",[function(){var a=!1,b=[],c=function(){for(var a;b.length;)a=b.splice(0,1),a[0]()},d=function(){ymaps.ready(function(){console.log("ymaps loaded"),a=!0,c()})};return window.ymaps?d():window.onYaMapLoad=function(){console.log("onYaMapLoad"),d()},function(d){b.push(d),a&&c()}}]).service("yaLayer",[function(){this.create=function(a,b){return new ymaps.Layer(a,b)}}]).service("yaMapType",[function(){this.create=function(a,b){return new ymaps.MapType(a,b)}}]).service("layerStorage",["mapApiLoad",function(a){this.get=function(b){if(this._storage)b(this._storage);else{var c=this;a(function(){c._storage=ymaps.layer.storage,b(c._storage)})}}}]).service("mapTypeStorage",["mapApiLoad",function(a){this.get=function(b){if(this._storage)b(this._storage);else{var c=this;a(function(){c._storage=ymaps.mapType.storage,b(c._storage)})}}}]).service("yaSubscriber",function(){var a=/^yaEvent(\w*)?([A-Z]{1}[a-z]+)$/;this.subscribe=function(b,c,d,e){var f=a.exec(d),g=f[2].toLowerCase(),h=f[1]?f[1][1].toLowerCase()+f[1].substring(1):void 0;e[d]=function(a){return c(e.$parent||e,a)};var i=h?b[h].events:b.events;i.add(g,function(a){setTimeout(function(){e.$apply(function(){e[d]({$event:a})})})})}}).service("templateLayoutFactory",["mapApiLoad",function(a){this._cache={},this.get=function(a){return this._cache[a]||a},this.create=function(b,c,d){if(!this._cache[b]){var e=this;a(function(){e._cache[b]=ymaps.templateLayoutFactory.createClass(c,d)})}}}]).directive("yaTemplateLayout",["templateLayoutFactory",function(a){return{restrict:"E",priority:1001,scope:{overrides:"=yaOverrides"},compile:function(b){var c=b.html();return b.children().remove(),function(b,d,e){if(!e.yaKey)throw new Error('not require attribute "key"');var f=e.yaKey;a.create(f,c,b.overrides)}}}}]).controller("YaMapCtrl",["$scope","mapApiLoad",YaMapCtrl]).directive("yaMap",["$compile","mapApiLoad","$window","yaSubscriber","$parse","$q","$timeout",function(a,b,c,d,e,f,g){return{restrict:"E",scope:{yaCenter:"@",yaType:"@",waitForCenter:"@",yaBeforeInit:"&",yaAfterInit:"&"},compile:function(c){c.attr("style","display:block;height:100%;width:100%;");var h=c.children(),i=null;return c.children().remove(),function(c,j,k){var l=function(a){try{return c.$eval(a)}catch(b){return a}},m=function(a){return i&&i.reject(),i=f.defer(),a?angular.isArray(a)?g(function(){i.resolve(a)}):angular.isString(a)&&(console.warn("String warning"),b(function(){ymaps.geocode(a,{results:1}).then(function(a){var b=a.geoObjects.get(0);c.$apply(function(){i.resolve(b.geometry.getCoordinates())})},function(a){c.$apply(function(){i.reject(a)})})})):(console.log("no-center"),b(function(){console.log("ymaps.geolocation.get"),ymaps.geolocation.get({provider:"yandex"}).then(function(a){g(function(){console.log("ymaps.geolocation.get recieved"),i.resolve(a.geoObjects.position)})},function(a){console.log("error defining center"),console.log(a),g(function(){i.resolve([37.617499,55.752023])})})})),i.promise},n=Number(k.yaZoom),o=k.yaBehaviors?k.yaBehaviors.split(" "):["default"],p=["default"];k.yaControls?p=k.yaControls.split(" "):angular.isDefined(k.yaControls)&&(p=[]);for(var q,r=[],s=[],t=0,u=o.length;u>t;t++)q=o[t],"-"===q[0]?r.push(q.substring(1)):s.push(q);0>n?n=0:n>23&&(n=23);var v,w=function(g){console.log("mapInit",g);var i=f.defer();return b(function(){c.yaBeforeInit();var b=k.yaOptions?c.$eval(k.yaOptions):void 0;b&&b.projection&&(b.projection=new ymaps.projection[b.projection.type](b.projection.bounds)),c.map=new ymaps.Map(j[0],{center:g,zoom:n,controls:p,type:k.yaType||"yandex#map",behaviors:s},b),c.map.behaviors.disable(r);for(var f in k)if(0===f.indexOf("yaEvent")){var l=e(k[f]);d.subscribe(c.map,l,f,c)}i.resolve(c.map),c.yaAfterInit({$target:c.map}),j.append(h),setTimeout(function(){c.$apply(function(){a(j.children())(c.$parent)})})}),i.promise};c.$watch("yaCenter",function(a){if(console.log("yaCenter",a),a){var b=l(a);m(b).then(function(a){if(!v){v=w(a);var b=!0}v.then(function(c){b||c.setCenter(a)})})}else console.warn("You should define ya-center attribute or just wait for its initialization")}),c.$watch("yaType",function(a){a&&v&&v.then(function(b){b.setType(a)})}),c.$on("$destroy",function(){c.map&&c.map.destroy()})}},controller:"YaMapCtrl"}}]).directive("yaControl",["yaSubscriber","templateLayoutFactory","$parse",function(a,b,c){return{restrict:"E",require:"^yaMap",scope:{yaAfterInit:"&"},link:function(d,e,f,g){var h=f.yaType[0].toUpperCase()+f.yaType.substring(1),i=function(a){try{return d.$eval(a)}catch(b){return a}},j=i(f.yaParams),k=f.yaOptions?d.$eval(f.yaOptions):void 0;if(k&&k.layout&&(k.layout=b.get(k.layout)),k&&k.itemLayout&&(k.itemLayout=b.get(k.itemLayout)),j&&j.items){for(var l,m=[],n=0,o=j.items.length;o>n;n++)l=j.items[n],m.push(new ymaps.control.ListBoxItem(l));j.items=m}var p=new ymaps.control[h](j);for(var q in k)k.hasOwnProperty(q)&&p.options.set(q,k[q]);for(q in f)if(0===q.indexOf("yaEvent")){var r=c(f[q]);a.subscribe(p,r,q,d)}g.addControl(p,k),d.yaAfterInit({$target:p})}}}]).controller("CollectionCtrl",["$scope",CollectionCtrl]).directive("yaCollection",["$compile","$timeout","yaSubscriber","$parse",function(a,b,c,d){return{require:"^yaMap",restrict:"E",scope:{yaAfterInit:"&"},compile:function(e){var f=e.contents();return e.children().remove(),function(e,g,h,i){var j=h.yaOptions?e.$eval(h.yaOptions):{},k=angular.isDefined(h.showAll)&&"false"!=h.showAll;if(k){var l,m=i.getMap(),n=function(){l&&b.cancel(l),l=b(function(){m.geoObjects.events.remove("add",n);var a=m.geoObjects.getBounds();a&&m.setBounds(a,{checkZoomRange:!0})},300)};m.geoObjects.events.add("add",n)}e.collection=new ymaps.GeoObjectCollection({},j);for(var o in h)if(0===o.indexOf("yaEvent")){var p=d(h[o]);c.subscribe(e.collection,p,o,e)}i.addGeoObjects(e.collection),e.yaAfterInit({$target:e.collection}),e.$on("$destroy",function(){e.collection&&i.removeGeoObjects(e.collection)}),g.append(f),a(g.children())(e.$parent)}},controller:"CollectionCtrl"}}]).directive("yaCluster",["yaSubscriber","$compile","templateLayoutFactory","$parse",function(a,b,c,d){return{require:"^yaMap",restrict:"E",scope:{yaAfterInit:"&"},compile:function(e){var f=e.contents();return e.children().remove(),function(e,g,h,i){var j=h.yaOptions?e.$eval(h.yaOptions):{};j&&j.clusterBalloonItemContentLayout&&(j.clusterBalloonItemContentLayout=c.get(j.clusterBalloonItemContentLayout)),j&&j.clusterBalloonContentLayout&&(j.clusterBalloonContentLayout=c.get(j.clusterBalloonContentLayout)),e.collection=new ymaps.Clusterer(j);for(var k in h)if(0===k.indexOf("yaEvent")){var l=d(h[k]);a.subscribe(e.collection,l,k,e)}i.addGeoObjects(e.collection),e.yaAfterInit({$target:e.collection}),e.$on("$destroy",function(){e.collection&&i.removeGeoObjects(e.collection)}),g.append(f),b(g.children())(e.$parent)}},controller:"CollectionCtrl"}}]).directive("yaGeoObject",["GEOMETRY_TYPES","yaSubscriber","templateLayoutFactory","$parse",function(a,b,c,d){return{restrict:"E",require:["^yaMap","?^yaCollection","?^yaCluster"],scope:{yaSource:"=",yaShowBalloon:"=",yaAfterInit:"&"},link:function(e,f,g,h){var i,j=h[2]||h[1]||h[0],k=g.yaOptions?e.$eval(g.yaOptions):void 0;k&&k.balloonContentLayout&&(k.balloonContentLayout=c.get(k.balloonContentLayout)),k&&k.iconLayout&&(k.iconLayout=c.get(k.iconLayout));var l=function(a,c){"Arrow"===a.geometry.type?(c=c||{},c.editorMenuManager=function(a){return a.push({title:"Удалить линию",onClick:function(){j.removeGeoObjects(i)}}),a},i=new ymaps.Arrow(a.geometry.coordinates,null,c)):i=new ymaps.GeoObject(a,c);for(var f in g)if(0===f.indexOf("yaEvent")){var h=d(g[f]);b.subscribe(i,h,f,e)}j.addGeoObjects(i),e.yaAfterInit({$target:i}),m(g.yaEdit),n(g.yaDraw),o(e.yaShowBalloon)};e.$watch("yaSource",function(b){if(b)if(i){i.geometry.setCoordinates(b.geometry.coordinates),i.geometry.getType()===a.CIRCLE&&i.geometry.setRadius(b.geometry.radius);var c=b.properties;for(var d in c)c.hasOwnProperty(d)&&i.properties.set(d,c[d])}else l(b,k);else i&&j.removeGeoObjects(i)},angular.equals);var m=function(a){angular.isDefined(a)&&"false"!==a?i&&i.editor.startEditing():angular.isDefined(a)&&i&&i.editor.stopEditing()},n=function(a){angular.isDefined(a)&&"false"!==a?i&&i.editor.startDrawing():angular.isDefined(a)&&i&&i.editor.stopDrawing()},o=function(a){a?i&&i.balloon.open():i&&i.balloon.close()};g.$observe("yaEdit",m),g.$observe("yaDraw",n),e.$watch("yaShowBalloon",o),e.$on("$destroy",function(){i&&j.removeGeoObjects(i)})}}}]).directive("yaHotspotLayer",[function(){return{restrict:"E",require:"^yaMap",link:function(a,b,c,d){if(!c.yaUrlTemplate)throw new Error('not exists required attribute "url-template"');if(!c.yaKeyTemplate)throw new Error('not exists required attribute "key-template"');var e=c.yaOptions?a.$eval(c.yaOptions):void 0;d.addHotspotLayer(c.yaUrlTemplate,c.yaKeyTemplate,e)}}}]).directive("yaImageLayer",[function(){return{restrict:"E",require:"^yaMap",link:function(a,b,c,d){if(!c.yaUrlTemplate)throw new Error('not exists required attribute "url-template"');var e=c.yaOptions?a.$eval(c.yaOptions):void 0;d.addImageLayer(c.yaUrlTemplate,e)}}}]).directive("yaDragger",["yaSubscriber","$parse","mapApiLoad",function(a,b,c){return{restrict:"EA",scope:{yaAfterInit:"&"},link:function(d,e,f){var g=f.yaOptions?d.$eval(f.yaOptions):{};c(function(){g.autoStartElement=e[0];var c=new ymaps.util.Dragger(g);for(var h in f)if(0===h.indexOf("yaEvent")){var i=b(f[h]);a.subscribe(c,i,h,d)}d.yaAfterInit({$target:c})})}}}]);